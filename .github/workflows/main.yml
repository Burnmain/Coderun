name: Rust Cross-Compile with SSH Access

on:
  workflow_dispatch:
    inputs:
      keep_alive_minutes:
        description: 'Keep runner alive (minutes)'
        required: true
        default: '60'

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUST_BACKTRACE: 1

jobs:
  rust-builder:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.keep_alive_minutes }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust with MUSL target
      run: |
        # Install Rust
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
        # Install target for OpenWrt ARMv8
        rustup target add aarch64-unknown-linux-musl
        
        # Show installed targets
        rustup target list --installed

    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          musl-tools \
          build-essential \
          pkg-config

    - name: Setup default build environment
      run: |
        # Set default environment variables for cross-compilation
        echo "RUSTFLAGS=-C target-feature=+a53 -C opt-level=z -C link-arg=-s" >> $GITHUB_ENV
        echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
        
        # Create build script with interactive menu
        cat > /home/runner/build-menu.sh << 'EOF'
#!/bin/bash

# Default build profile
DEFAULT_FLAGS="-C target-feature=+a53 -C opt-level=z -C link-arg=-s"

echo "========================================"
echo "    RUST CROSS-COMPILATION BUILDER"
echo "========================================"
echo "Target: aarch64-unknown-linux-musl"
echo "Current RUSTFLAGS: ${RUSTFLAGS:-$DEFAULT_FLAGS}"
echo ""

PS3='Pilih build profile [1-5]: '
options=(
    "Small size (opt-level=z) - untuk OpenWrt"
    "Fast (opt-level=3) - performa maksimal"
    "Balanced (opt-level=2) - default cargo"
    "Debug (no optimizations) - debugging"
    "Custom RUSTFLAGS - input manual"
)

select opt in "${options[@]}"
do
    case $REPLY in
        1)
            export RUSTFLAGS="-C target-feature=+a53 -C opt-level=z -C link-arg=-s"
            echo "‚úì Menggunakan: Small size optimization"
            break
            ;;
        2)
            export RUSTFLAGS="-C target-feature=+a53 -C opt-level=3"
            echo "‚úì Menggunakan: Fast optimization"
            break
            ;;
        3)
            export RUSTFLAGS="-C target-feature=+a53 -C opt-level=2"
            echo "‚úì Menggunakan: Balanced optimization"
            break
            ;;
        4)
            export RUSTFLAGS=""
            echo "‚úì Menggunakan: No optimization (debug)"
            break
            ;;
        5)
            read -p "Masukkan RUSTFLAGS custom: " custom_flags
            export RUSTFLAGS="$custom_flags"
            echo "‚úì Menggunakan: Custom flags"
            break
            ;;
        *) 
            echo "Pilihan invalid. Coba lagi."
            ;;
    esac
done

echo ""
echo "RUSTFLAGS yang aktif: $RUSTFLAGS"
echo ""

# Ask for build command
read -p "Jalankan cargo build? (y/n): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üöÄ Building dengan command:"
    echo "cargo build --release --target aarch64-unknown-linux-musl"
    echo ""
    
    # Execute build
    cargo build --release --target aarch64-unknown-linux-musl
    
    if [ $? -eq 0 ]; then
        echo ""
        echo "‚úÖ BUILD BERHASIL!"
        echo "Binary tersedia di: target/aarch64-unknown-linux-musl/release/"
        echo ""
        ls -lh target/aarch64-unknown-linux-musl/release/
    else
        echo ""
        echo "‚ùå BUILD GAGAL!"
    fi
else
    echo "Build dibatalkan."
    echo "Anda bisa jalankan manual dengan:"
    echo "  cargo build --release --target aarch64-unknown-linux-musl"
fi
EOF

        chmod +x /home/runner/build-menu.sh
        
        # Create quick build script (one-liner)
        cat > /home/runner/quick-build.sh << 'EOF'
#!/bin/bash
# Quick build dengan default settings
export RUSTFLAGS="-C target-feature=+a53 -C opt-level=z -C link-arg=-s"
cargo build --release --target aarch64-unknown-linux-musl
EOF
        chmod +x /home/runner/quick-build.sh

    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rust-builder-${{ github.run_id }}
        
        # Get Tailscale IP
        sleep 5
        TS_IP=$(tailscale ip -4)
        echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

    - name: Setup SSH Access
      run: |
        # Install SSH server
        sudo apt-get install -y openssh-server
        
        # Create SSH user
        SSH_PASSWORD="rust-$(openssl rand -hex 6)"
        sudo useradd -m -s /bin/bash rustuser
        echo "rustuser:$SSH_PASSWORD" | sudo chpasswd
        sudo usermod -aG sudo rustuser
        
        # Allow password authentication
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh
        
        echo "SSH_CREDS=rustuser@${{ env.TAILSCALE_IP }} | Password: $SSH_PASSWORD" >> $GITHUB_ENV

    - name: Create project template
      run: |
        # Create minimal Cargo.toml template jika belum ada
        if [ ! -f "Cargo.toml" ]; then
            cat > Cargo.toml << 'EOF'
[package]
name = "my-openwrt-app"
version = "0.1.0"
edition = "2021"

[profile.release]
strip = true
lto = true
codegen-units = 1

[dependencies]
# Tambahkan dependencies di sini
EOF
            echo "üìÅ Created Cargo.toml template"
        fi
        
        # Create src directory jika belum ada
        mkdir -p src
        if [ ! -f "src/main.rs" ]; then
            cat > src/main.rs << 'EOF'
fn main() {
    println!("Hello OpenWrt ARMv8!");
}
EOF
            echo "üìÅ Created src/main.rs template"
        fi

    - name: Display Connection Info
      run: |
        echo ""
        echo "========================================"
        echo "üöÄ RUST CROSS-COMPILATION BUILDER READY"
        echo "========================================"
        echo ""
        echo "üì° SSH ACCESS:"
        echo "  Address: ${{ env.TAILSCALE_IP }}"
        echo "  Username: rustuser"
        echo "  Password: $(echo ${{ env.SSH_CREDS }} | grep -o 'Password: .*' | cut -d' ' -f2-)"
        echo ""
        echo "üîß BUILD TOOLS:"
        echo "  Rust target: aarch64-unknown-linux-musl"
        echo "  Linker: aarch64-linux-gnu-gcc"
        echo "  Default RUSTFLAGS: -C target-feature=+a53 -C opt-level=z -C link-arg=-s"
        echo ""
        echo "üìÇ PROJECT STRUCTURE:"
        echo "  /home/runner/work/<repo>/<repo>/"
        echo "  ‚îú‚îÄ‚îÄ Cargo.toml"
        echo "  ‚îú‚îÄ‚îÄ src/main.rs"
        echo "  ‚îî‚îÄ‚îÄ build-menu.sh (interactive build script)"
        echo ""
        echo "‚ö° QUICK COMMANDS (setelah login SSH):"
        echo "  ./build-menu.sh              # Interactive build menu"
        echo "  ./quick-build.sh             # Quick build dengan default"
        echo "  nano src/main.rs             # Edit source code"
        echo "  cargo build --release --target aarch64-unknown-linux-musl"
        echo ""
        echo "‚è∞ Runner akan aktif selama ${{ github.event.inputs.keep_alive_minutes }} menit"
        echo "========================================"
        echo ""

    - name: Keep runner alive
      run: |
        # Convert minutes to seconds
        TIMEOUT=$(( ${{ github.event.inputs.keep_alive_minutes }} * 60 ))
        echo "‚è≥ Runner akan aktif selama $TIMEOUT detik..."
        
        # Countdown timer
        for ((i=TIMEOUT; i>0; i--)); do
            printf "\r‚è∞ Waktu tersisa: %02d:%02d" $((i/60)) $((i%60))
            sleep 1
        done
        echo ""
        echo "‚è∞ Waktu habis! Runner akan berhenti."
